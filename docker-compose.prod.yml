# Docker Compose - Production/Development Stack
#
# Runs the complete Flashcard Orchestrator stack including:
# - API server
# - Orchestrator worker
# - Transcription worker
# - Redis (job queue)
# - Qdrant (vector DB, optional)
# - PostgreSQL (optional, or use managed DB)
# - Prometheus (metrics)
# - Grafana (dashboards, optional)
#
# Usage:
#   # Start all services
#   docker compose -f docker-compose.prod.yml up -d
#
#   # Start specific services
#   docker compose -f docker-compose.prod.yml up -d api redis qdrant
#
#   # View logs
#   docker compose -f docker-compose.prod.yml logs -f orchestrator_worker
#
#   # Stop all
#   docker compose -f docker-compose.prod.yml down
#
# Required Environment Variables (create .env or export):
#   - GEMINI_API_KEY or OPENAI_API_KEY
#   - SIGNING_KEY (for JWT tokens)
#   - DATABASE_URL (optional, defaults to local postgres)
#
# See env.sample for full list of variables.

version: '3.9'

services:
  # ===========================================================================
  # API Server
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flashcard-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-5000}:5000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5000
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/flashcards}
      - VECTOR_DB_PROVIDER=${VECTOR_DB_PROVIDER:-qdrant}
      - QDRANT_URL=http://qdrant:6333
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - SIGNING_KEY=${SIGNING_KEY:-dev-signing-key-change-me}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-gemini}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - flashcard-network
    volumes:
      - ./server/tmp:/app/server/tmp

  # ===========================================================================
  # Orchestrator Worker
  # ===========================================================================
  orchestrator_worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flashcard-orchestrator-worker
    restart: unless-stopped
    command: [ "npm", "run", "worker:orchestrator" ]
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=${DATABASE_URL:-postgres://postgres:postgres@postgres:5432/flashcards}
      - VECTOR_DB_PROVIDER=${VECTOR_DB_PROVIDER:-qdrant}
      - QDRANT_URL=http://qdrant:6333
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-gemini}
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-2}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - COST_BUDGET_DAILY=${COST_BUDGET_DAILY:-100}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "node", "-e", "require('net').connect(9090).on('error',()=>process.exit(1))" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - flashcard-network
    volumes:
      - ./server/tmp:/app/server/tmp
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # Transcription Worker
  # ===========================================================================
  transcription_worker:
    build:
      context: .
      dockerfile: Dockerfile.whisperx
    container_name: flashcard-transcription-worker
    restart: unless-stopped
    command: [ "npm", "run", "worker:transcription" ]
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - REDIS_URL=redis://redis:6379
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-whisperx}
      - WHISPERX_MODEL=${WHISPERX_MODEL:-base}
      - HF_TOKEN=${HF_TOKEN:-}
      - WORKER_CONCURRENCY=${TRANSCRIPTION_CONCURRENCY:-1}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - flashcard-network
    volumes:
      - ./server/tmp:/app/server/tmp
      - whisperx-models:/root/.cache/huggingface
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G
    # Uncomment for GPU support:
    # runtime: nvidia
    # environment:
    #   - NVIDIA_VISIBLE_DEVICES=all

    # ===========================================================================
    # Redis (Job Queue)
    # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: flashcard-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - flashcard-network
    volumes:
      - redis-data:/data

  # ===========================================================================
  # Qdrant (Vector Database)
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: flashcard-qdrant
    restart: unless-stopped
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6333/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - flashcard-network
    volumes:
      - qdrant-data:/qdrant/storage
    profiles:
      - full
      - with-qdrant

  # ===========================================================================
  # PostgreSQL (Database)
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: flashcard-postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-flashcards}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - flashcard-network
    volumes:
      - postgres-data:/var/lib/postgresql/data
    profiles:
      - full
      - with-db

  # ===========================================================================
  # Prometheus (Metrics Collection)
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: flashcard-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - flashcard-network
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus-rules.yml:/etc/prometheus/rules.yml:ro
      - prometheus-data:/prometheus
    profiles:
      - full
      - monitoring

  # ===========================================================================
  # Grafana (Dashboards)
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: flashcard-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    networks:
      - flashcard-network
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana-provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    profiles:
      - full
      - monitoring

# =============================================================================
# Networks
# =============================================================================
networks:
  flashcard-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis-data:
  qdrant-data:
  postgres-data:
  prometheus-data:
  grafana-data:
  whisperx-models:
